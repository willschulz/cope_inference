# CoPE VM Image Lifecycle: Stand‑Up & Tear‑Down

This document describes how to **safely stand up and tear down a CoPE inference VM** from a stored custom image. It is intended as an operator reference for future you.

---

## Overview

We use a **custom GCE image** as the source of truth for the CoPE runtime environment.

* Image name: `cope-base-v1`
* Image family: `cope-base`
* Project: `gcp-vox`

Instances created from this image:

* Start quickly
* Auto-start the CoPE service via `systemd`
* Can be deleted at any time without data loss

The image is the durable artifact. **VMs are disposable.**

---

## 1. Tear Down a Running Test VM

To delete a temporary instance (example: `coper-v1-test2`):

```bash
gcloud compute instances delete coper-v1-test2 \
  --project=gcp-vox \
  --zone=northamerica-northeast1-b
```

Notes:

* This stops billing for CPU, RAM, and GPU immediately
* The underlying image (`cope-base-v1`) is untouched
* Safe to do at any time once testing is complete

---

## 2. Stand Up a CoPE VM from the Image

Create a fresh CoPE VM from the stored image:

```bash
gcloud compute instances create coper-v1 \
  --project=gcp-vox \
  --zone=northamerica-northeast1-b \
  --image=cope-base-v1 \
  --image-project=gcp-vox \
  --machine-type=g2-custom-4-24576 \
  --accelerator=type=nvidia-l4,count=1 \
  --maintenance-policy=TERMINATE \
  --restart-on-failure \
  --boot-disk-size=200GB \
  --boot-disk-type=pd-ssd
```

What this does:

* Allocates a fresh boot disk from the image
* Attaches an NVIDIA L4 GPU
* Boots the VM and automatically starts `cope-vllm`

---

## 3. Verify the Service After Boot

After ~1–3 minutes, verify from a client machine:

```bash
curl http://<TAILSCALE_IP>:8000/health
```

Expected:

* `status: healthy`
* `model_loaded: true`
* `gpu_available: true`

You can also SSH into the VM:

```bash
gcloud compute ssh coper-v1 \
  --project=gcp-vox \
  --zone=northamerica-northeast1-b
```

And check locally:

```bash
nvidia-smi
sudo systemctl status cope-vllm
```

---

## 4. Stop vs Delete: Which to Use?

### Delete (recommended)

```bash
gcloud compute instances delete coper-v1 \
  --project=gcp-vox \
  --zone=northamerica-northeast1-b
```

* Frees all compute and GPU resources
* No lingering disk costs
* Image remains available

### Stop (only for short pauses)

```bash
gcloud compute instances stop coper-v1 \
  --project=gcp-vox \
  --zone=northamerica-northeast1-b
```

* CPU/GPU billing stops
* Disk billing continues
* Prefer delete if idle > a few days

---

## 5. Updating the Image (Future Changes)

When you modify CoPE (model upgrade, code change, config tweak):

1. Boot a VM from the current image
2. Apply changes and verify correctness
3. Create a new image:

```bash
gcloud compute images create cope-base-v2 \
  --source-disk=coper-v1 \
  --source-disk-zone=northamerica-northeast1-b \
  --family=cope-base
```

4. Delete the VM
5. Use `cope-base-v2` for future instances

Never modify a running VM and rely on it long-term without re-imaging.

---

## 6. Mental Model (Important)

* **Image** = immutable, cheap, long-lived
* **VM** = temporary, expensive, disposable
* **Delete aggressively, recreate confidently**

This pattern keeps costs low and failures boring.

---

End of document.
